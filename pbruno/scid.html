<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCID-5-CV: Depressão | Bruno de Souza</title>
    
    <script>
        // Mantendo sua verificação de login
        if(localStorage.getItem('logado') !== 'sim') {
            // window.location.href = "../login.html"; // Comentei para eu poder testar aqui, mas você pode descomentar
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f8ff;
            --primary: #6c5ce7;
            --text: #2d3436;
            --card-bg: #ffffff;
            --positive: #ef5350;
            --negative: #00b894;
            --neutral: #fdcb6e;
            --criteria-bg: #dfe6e9;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#dfe6e9 2px, transparent 2px);
            background-size: 20px 20px;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 40px;
            border-radius: 20px;
            border: 3px dashed var(--primary);
            box-shadow: 8px 8px 0 rgba(0,0,0,0.05);
            max-width: 900px;
            width: 100%;
            position: relative;
        }

        header::before {
            content: ""; 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 5px; 
            background-color: rgba(108, 92, 231, 0.3); 
            border-radius: 10px;
        }

        h1 { margin: 0; color: var(--primary); font-size: 1.8rem; text-transform: uppercase; font-weight: 800; }
        .subtitle { margin-top: 5px; color: #636e72; font-weight: 600; font-size: 0.9rem; }
        .badge { background: var(--primary); color: white; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; position: absolute; top: -15px; right: 20px; }

        #app-container {
            display: grid;
            grid-template-columns: 2fr 1fr 100px;
            gap: 20px;
            width: 100%;
            max-width: 1100px;
            height: 60vh;
            min-height: 500px;
        }

        .question-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            border: 2px solid white;
            position: relative;
            overflow-y: auto;
        }

        .question-code {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: block;
        }

        .question-text {
            font-size: 1.4rem;
            line-height: 1.4;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 25px;
        }

        .sub-questions {
            font-size: 1rem;
            color: #636e72;
            background: #f1f2f6;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid var(--primary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .instruction {
            margin-top: auto;
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px dashed #ffeeba;
        }

        .criteria-panel {
            background: var(--criteria-bg);
            border-radius: 20px;
            padding: 25px;
            overflow-y: auto;
            border: 2px solid #b2bec3;
            color: #2d3436;
        }

        .criteria-title { 
            font-weight: 800; 
            margin-bottom: 15px; 
            text-transform: uppercase; 
            font-size: 0.9rem; 
            color: #636e72; 
            border-bottom: 2px solid rgba(0,0,0,0.1);
            padding-bottom: 5px;
        }
        
        .criteria-text { font-size: 0.95rem; line-height: 1.5; }

        .action-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center;
        }

        .btn-action {
            width: 100%;
            height: 80px;
            border: none;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 800;
            cursor: pointer;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
        }

        .btn-action span { font-size: 0.7rem; font-weight: 600; margin-top: 5px; text-transform: uppercase; }

        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 8px 0 rgba(0,0,0,0.1); }
        .btn-action:active { transform: translateY(2px); box-shadow: none; }

        .btn-plus { background-color: var(--positive); }
        .btn-minus { background-color: var(--negative); }
        .btn-unsure { background-color: var(--neutral); color: #2d3436; }

        #results-view {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 25px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .result-item {
            padding: 15px;
            border-bottom: 1px dashed #dfe6e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .diagnosis-box {
            margin-top: 30px;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 800;
        }
        
        .diag-positive { background: #ff7675; color: white; border: 4px solid #d63031; }
        .diag-negative { background: #55efc4; color: #006266; border: 4px solid #00b894; }
        .diag-neutral { background: #dfe6e9; color: #2d3436; border: 4px solid #b2bec3; }

        .back-link {
            position: fixed; top: 20px; left: 20px;
            color: #b2bec3; text-decoration: none; font-weight: 700;
            transition: 0.3s;
        }
        .back-link:hover { color: var(--primary); }

        @media (max-width: 900px) {
            #app-container {
                display: flex;
                flex-direction: column;
                height: auto;
            }
            .action-panel {
                flex-direction: row;
                height: auto;
            }
            .btn-action { height: 60px; font-size: 1.2rem; }
            .question-panel { min-height: 300px; }
        }
    </style>
</head>
<body>

    <a href="../listaferramentas.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar</a>

    <header data-aos="fade-down">
        <h1>SCID-5-CV Digital</h1>
        <div class="subtitle">Módulo A: Episódio Depressivo Maior</div>
        <div class="badge" id="progress-display">Item 1</div>
    </header>

    <div id="app-container" data-aos="fade-up">
        
        <div class="question-panel">
            <span class="question-code" id="q-id">A1</span>
            <div class="question-text" id="q-main">
                Carregando...
            </div>
            
            <div class="sub-questions" id="q-sub" style="display:none;"></div>

            <div class="instruction" id="q-inst" style="display:none;"></div>
        </div>

        <div class="criteria-panel">
            <div class="criteria-title"><i class="fa-solid fa-book-medical"></i> Critério DSM-5</div>
            <div class="criteria-text" id="c-text">
                Carregando...
            </div>
        </div>

        <div class="action-panel">
            <button class="btn-action btn-plus" onclick="registerScore('+')">
                <i class="fa-solid fa-check"></i> <span>Presente</span>
            </button>
            <button class="btn-action btn-unsure" onclick="registerScore('?')">
                <i class="fa-solid fa-question"></i> <span>Dúvida</span>
            </button>
            <button class="btn-action btn-minus" onclick="registerScore('-')">
                <i class="fa-solid fa-xmark"></i> <span>Ausente</span>
            </button>
        </div>
    </div>

    <div id="results-view">
        <h2 style="text-align:center; color:var(--text)">Sumário da Avaliação</h2>
        <div id="score-list"></div>
        <div id="final-diagnosis" class="diagnosis-box"></div>
        <button class="btn-action btn-unsure" style="margin-top:20px; height:50px; background:#b2bec3" onclick="location.reload()">
            <i class="fa-solid fa-rotate-right"></i> Nova Avaliação
        </button>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();

        const questions = [
            // --- INÍCIO DO MÓDULO A (EPISÓDIO ATUAL) ---
            {
                id: "A1",
                text: "No último mês, houve algum período em que você se sentiu deprimido ou abatido na maior parte do dia, quase todos os dias?",
                sub: "Alguém comentou que você parecia triste, abatido ou 'para baixo'?",
                criteria: "1. Humor deprimido na maior parte do dia, quase todos os dias (relato subjetivo ou observação).",
                inst: "Se o paciente estiver visivelmente deprimido, marque (+) mesmo se ele negar."
            },
            {
                id: "A2",
                text: "Durante esse período, você sentiu menos interesse ou prazer nas coisas que normalmente gosta?",
                sub: "Houve um período em que você 'não sentia gosto por nada'?",
                criteria: "2. Acentuada diminuição de interesse ou prazer em quase todas as atividades."
            },
            // PONTO DE CHECAGEM CRÍTICO
            {
                id: "CHECK_ENTRY",
                type: "logic",
                check: function(scores) {
                    if (scores['A1'] !== '+' && scores['A2'] !== '+') {
                        // Se não tem sintomas atuais, vamos verificar o PASSADO.
                        return 'JUMP_TO_A14'; 
                    }
                    return 'NEXT';
                }
            },
            {
                id: "A3",
                text: "Como estava o seu apetite? Houve alguma mudança de peso (sem dieta)?",
                sub: "Teve que se forçar a comer? Ou comeu muito mais que o habitual?",
                criteria: "3. Perda ou ganho significativo de peso (5% em um mês) ou alteração no apetite."
            },
            {
                id: "A4",
                text: "Como você estava dormindo?",
                sub: "Dificuldade para pegar no sono? Acordar no meio da noite? Dormir demais?",
                criteria: "4. Insônia ou hipersonia quase todos os dias."
            },
            {
                id: "A5",
                text: "Você se sentiu agitado (não conseguindo ficar parado) ou muito lento (câmera lenta)?",
                sub: "Outras pessoas notaram isso?",
                criteria: "5. Agitação ou retardo psicomotor (deve ser observável por outros).",
                inst: "A mera sensação subjetiva de inquietude não conta. Deve ser visível."
            },
            {
                id: "A6",
                text: "Como estava sua energia? Sentiu-se cansado ou sem forças?",
                sub: "Mesmo sem fazer esforço físico?",
                criteria: "6. Fadiga ou perda de energia quase todos os dias."
            },
            {
                id: "A7",
                text: "Como se sentiu em relação a si mesmo? Sentiu-se inútil ou culpado?",
                sub: "Sentiu que decepcionou as pessoas ou se culpou por coisas do passado?",
                criteria: "7. Sentimentos de inutilidade ou culpa excessiva/inapropriada."
            },
            {
                id: "A8",
                text: "Teve dificuldade para pensar, concentrar-se ou tomar decisões?",
                sub: "Ficou indeciso sobre coisas simples do dia a dia?",
                criteria: "8. Capacidade diminuída para pensar/concentrar ou indecisão."
            },
            {
                id: "A9",
                text: "Teve pensamentos de morte ou de se machucar?",
                sub: "Pensou que seria melhor não acordar? Pensou em suicídio?",
                criteria: "9. Pensamentos recorrentes de morte, ideação suicida ou tentativa.",
                inst: "ALERTA: Se (+), avalie risco de suicídio imediato."
            },
            // CONTAGEM DE SINTOMAS ATUAIS
            {
                id: "CHECK_COUNT",
                type: "logic",
                check: function(scores) {
                    let count = 0;
                    ['A1', 'A2', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'A9'].forEach(key => {
                        if (scores[key] === '+') count++;
                    });
                    
                    if (count < 5) return 'JUMP_TO_A14'; // Não fecha critério ATUAL, verifica o PASSADO.
                    return 'NEXT';
                }
            },
            {
                id: "A10", 
                text: "Esses sintomas atrapalharam sua vida (trabalho, estudos, social)?",
                sub: "Causaram muito sofrimento?",
                criteria: "B. Sofrimento clinicamente significativo ou prejuízo no funcionamento.",
                inst: "Se o prejuízo for óbvio (ex: não sai da cama), marque (+)."
            },
            {
                id: "A11",
                text: "Você estava doente fisicamente ou usando substâncias quando isso começou?",
                sub: "Remédios, drogas ou álcool?",
                criteria: "C. Não atribuível a efeitos de substância ou condição médica.",
                inst: "Se for causado por droga/doença, marque (-) pois não é TDM primário."
            },
            {
                id: "A12",
                text: "Quando esse período começou?",
                sub: "Registre a data aproximada.",
                criteria: "Cronologia do Episódio.",
                inst: "Apenas registro de dados."
            },

            // --- TRANSIÇÃO: LÓGICA DE RECORRÊNCIA ---
            // Se chegou aqui, o paciente TEM depressão atual. Vamos ver se teve antes.
            {
                id: "A13",
                text: "Antes desse episódio, você JÁ teve algum outro período parecido?",
                sub: "Houve alguma época no passado que foi igual a esta, com pelo menos 2 meses de intervalo?",
                criteria: "Verificação de Recorrência (Episódio Único vs. Recorrente).",
                inst: "Se SIM (+), o diagnóstico é Depressão Recorrente. Pula o rastreio do passado.",
            },

            // Se respondeu A13 (Recorrência), não precisa fazer o rastreio completo do passado.
            {
                id: "CHECK_RECURRENCE",
                type: "logic",
                check: function(scores) {
                    if (scores['A13']) {
                        return 'SKIP_TO_END'; // Fim da entrevista, diagnóstico completo.
                    }
                    return 'NEXT';
                }
            },

            // --- INÍCIO DO MÓDULO EPISÓDIO PASSADO (Para quem não tem atual) ---
            {
                id: "A14",
                text: "Você JÁ teve algum período na sua vida (no passado) em que se sentiu deprimido a maior parte do dia?",
                sub: "Pense na pior fase da sua vida. Como você se sentia?",
                criteria: "A. Rastreio de Humor Deprimido no PASSADO."
            },
            {
                id: "A15",
                text: "E houve algum período no passado em que você perdeu o interesse ou prazer pelas coisas?",
                criteria: "A. Rastreio de Anedonia no PASSADO."
            },
            // Se não teve nada no passado, acaba.
            {
                id: "CHECK_PAST_CORE",
                type: "logic",
                check: function(scores) {
                    if (scores['A14'] !== '+' && scores['A15'] !== '+') {
                        return 'SKIP_TO_END'; 
                    }
                    return 'NEXT';
                }
            },
            {
                id: "A_PAST_FULL",
                text: "Durante esse pior episódio do passado, você teve vários daqueles outros sintomas (sono, peso, culpa, concentração) ao mesmo tempo?",
                sub: "Durou pelo menos 2 semanas?",
                criteria: "B. Confirmação de Episódio Depressivo Maior Passado.",
                inst: "Marque (+) se houve um episódio completo no passado."
            }
        ];

        // ============================================================
        // MOTOR DO APP (ATUALIZADO PARA PULOS ESPECÍFICOS)
        // ============================================================
        let currentIndex = 0;
        let scores = {};

        function loadQuestion() {
            if (currentIndex >= questions.length) {
                showResults();
                return;
            }

            const q = questions[currentIndex];

            // --- LÓGICA DE PULOS INTELIGENTE ---
            if (q.type === 'logic') {
                const action = q.check(scores);
                
                if (action === 'SKIP_TO_END') {
                    showResults(); // Fim da linha
                    return;
                } 
                // Novo recurso: Pular para ID específico
                else if (action.startsWith('JUMP_TO_')) {
                    const targetId = action.split('JUMP_TO_')[1];
                    const targetIndex = questions.findIndex(item => item.id === targetId);
                    
                    if (targetIndex !== -1) {
                        currentIndex = targetIndex;
                        loadQuestion();
                    } else {
                        console.error("Erro: Destino de pulo não encontrado ->", targetId);
                        showResults();
                    }
                    return;
                }
                // Segue normal
                else {
                    currentIndex++;
                    loadQuestion();
                    return;
                }
            }
            // -----------------------------------

            // Atualiza Interface
            document.getElementById('q-id').innerText = q.id;
            document.getElementById('q-main').innerText = q.text;
            document.getElementById('c-text').innerText = q.criteria;
            document.getElementById('progress-display').innerText = `Item ${currentIndex + 1}`;

            // Sub-perguntas
            const subDiv = document.getElementById('q-sub');
            if (q.sub) {
                subDiv.style.display = 'block';
                subDiv.innerText = q.sub;
            } else {
                subDiv.style.display = 'none';
            }

            // Instruções
            const instDiv = document.getElementById('q-inst');
            if (q.inst) {
                instDiv.style.display = 'block';
                instDiv.innerText = "NOTA CLÍNICA: " + q.inst;
            } else {
                instDiv.style.display = 'none';
            }
        }

        function registerScore(value) {
            const q = questions[currentIndex];
            scores[q.id] = value;
            currentIndex++;
            loadQuestion();
        }

        function showResults() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('results-view').style.display = 'block';
            
            const list = document.getElementById('score-list');
            const diagBox = document.getElementById('final-diagnosis');
            list.innerHTML = '';

            // Lógica de Diagnóstico Atual
            let currentSymptoms = 0;
            ['A1','A2','A3','A4','A5','A6','A7','A8','A9'].forEach(k => { if(scores[k] === '+') currentSymptoms++; });
            
            let hasCurrent = (scores['A1'] === '+' || scores['A2'] === '+') && currentSymptoms >= 5;
            let hasPast = scores['A_PAST_FULL'] === '+';
            let isRecurrent = scores['A13'] === '+';

            // Gera lista visual
            Object.keys(scores).forEach(key => {
                const val = scores[key];
                // Ignora chaves internas de lógica para o relatório
                if (['CHECK_ENTRY', 'CHECK_COUNT', 'CHECK_RECURRENCE', 'CHECK_PAST_CORE'].includes(key)) return;

                let colorClass = val === '+' ? 'color:#ef5350; font-weight:bold;' : 'color:#2d3436;';
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<span>${key}</span> <span style="${colorClass}">${val}</span>`;
                list.appendChild(div);
            });

            // RESULTADO FINAL
            if (hasCurrent) {
                let tipo = isRecurrent ? "RECORRENTE" : "EPISÓDIO ÚNICO";
                diagBox.className = "diagnosis-box diag-positive";
                diagBox.innerHTML = `<i class='fa-solid fa-triangle-exclamation'></i> TRANSTORNO DEPRESSIVO MAIOR (${tipo})<br><small>Episódio Atual Confirmado (${currentSymptoms} sintomas).</small>`;
            } 
            else if (hasPast) {
                diagBox.className = "diagnosis-box diag-neutral";
                diagBox.innerHTML = `<i class='fa-solid fa-clock-rotate-left'></i> TDM EM REMISSÃO (Histórico Passado)<br><small>Não tem depressão hoje, mas teve no passado.</small>`;
            } 
            else {
                diagBox.className = "diagnosis-box diag-negative";
                diagBox.innerHTML = "<i class='fa-solid fa-circle-check'></i> SEM DIAGNÓSTICO DE TDM<br><small>Critérios não atendidos no presente nem no passado.</small>";
            }
        }

        // Iniciar
        loadQuestion();

    </script>
</body>
</html>
