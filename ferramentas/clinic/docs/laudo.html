<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Laudo | CFP</title>
    
    <script>
        if(localStorage.getItem('logado') !== 'sim') {
            window.location.href = "../../../login.html"; 
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="../../../assets/style.css">
    <script src="../../../assets/layout.js"></script>
    <script src="../../../assets/print.js"></script>

    <style>
        /* Visualização do Documento (Papel A4) */
        .doc-preview {
            background: white;
            border: 1px solid #ccc;
            padding: 80px 60px;
            min-height: 900px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.5;
            color: #000;
            display: none;
            text-align: justify;
        }

        .doc-title {
            text-align: center;
            font-weight: bold;
            font-size: 14pt;
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        .doc-section-title {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 12pt;
        }

        .doc-content {
            margin-bottom: 15px;
            text-indent: 2cm;
        }

        /* Tabela de Identificação (Padrão CFP) */
        .ident-table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }
        .ident-table td {
            padding: 2px 0;
            vertical-align: top;
        }
        .ident-label { font-weight: bold; width: 140px; }

        .signature-section {
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            break-inside: avoid;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 400px;
            padding-top: 10px;
            font-size: 12pt;
        }

        /* Botões Mágicos */
        .magic-input-wrapper { position: relative; }
        
        .btn-magic {
            position: absolute; bottom: 10px; right: 10px;
            background: var(--primary-color); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0.7; transition: 0.3s;
        }
        .btn-magic:hover { opacity: 1; transform: scale(1.1); }
        .btn-magic.loading { background: #b2bec3; cursor: wait; animation: pulse 1s infinite; }
        
        textarea { min-height: 100px; padding-bottom: 40px; font-family: 'Quicksand', sans-serif; }

        /* Config IA Flutuante */
        .ai-config-float { position: fixed; top: 100px; right: 20px; z-index: 100; }
        .btn-config-ia {
            background: #2d3436; color: white; padding: 8px 15px; border-radius: 30px;
            font-size: 0.8rem; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ff7675; }
        .status-dot.active { background: #00b894; box-shadow: 0 0 5px #00b894; }

        @media (max-width: 1200px) { .ai-config-float { top: auto; bottom: 20px; left: 20px; right: auto; } }

        @media print {
            .no-print, .app-header, .fab, .btn-back-home, .card-panel, .ai-config-float { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            .doc-preview { display: block !important; box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; }
            #editorArea { display: block !important; margin: 0 !important; width: 100% !important; }
        }
    </style>
</head>
<body>

    <script>
        carregarHeader("Gerador de Laudo", "Avaliação Psicológica (Res. CFP 06/2019)");
    </script>

    <div class="ai-config-float no-print">
        <button class="btn-config-ia" onclick="configureKey()">
            <div class="status-dot" id="status-dot"></div> Configurar IA
        </button>
    </div>

    <div class="card-panel no-print" style="max-width: 900px; margin: 0 auto;">
        
        <h3 style="color:var(--primary-color); margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <i class="fa-solid fa-clipboard-list"></i> Dados da Avaliação
        </h3>

        <div class="grid-2">
            <div>
                <label class="form-label">Nome do Avaliado (Paciente):</label>
                <input type="text" id="paciente" class="form-control" placeholder="Nome completo">
            </div>
            <div>
                <label class="form-label">Solicitante (Quem pediu?):</label>
                <input type="text" id="solicitante" class="form-control" placeholder="Ex: Justiça, Médico, Escola, O Próprio...">
            </div>
        </div>
        <div style="margin-top:10px;">
            <label class="form-label">Finalidade:</label>
            <input type="text" id="finalidade" class="form-control" placeholder="Ex: Avaliação para cirurgia, Diagnóstico diferencial...">
        </div>

        <div style="margin-top:30px;">
            <label class="form-label">I. Descrição da Demanda:</label>
            <div class="magic-input-wrapper">
                <textarea id="textoDemanda" class="form-control" placeholder="Motivo do encaminhamento, queixas principais..."></textarea>
                <button class="btn-magic" onclick="improveText('textoDemanda', 'DEMANDA')" title="IA: Formalizar Demanda"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">II. Procedimento (Metodologia):</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Cite número de sessões, testes aplicados, entrevistas e datas.</div>
            <div class="magic-input-wrapper">
                <textarea id="textoProcedimento" class="form-control" placeholder="Ex: Foram realizadas 05 sessões de 50min. Utilizou-se entrevista semi-estruturada e o Inventário X..."></textarea>
                <button class="btn-magic" onclick="improveText('textoProcedimento', 'PROCEDIMENTO')" title="IA: Descrever Metodologia"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">III. Análise:</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Integração dos dados colhidos. Relate os resultados dos instrumentos e observações.</div>
            <div class="magic-input-wrapper">
                <textarea id="textoAnalise" class="form-control" style="min-height:200px;" placeholder="Discorra sobre os achados clínicos..."></textarea>
                <button class="btn-magic" onclick="improveText('textoAnalise', 'ANÁLISE')" title="IA: Linguagem Técnica"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">IV. Conclusão:</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Resultado final, encaminhamentos ou hipótese diagnóstica (se houver).</div>
            <div class="magic-input-wrapper">
                <textarea id="textoConclusao" class="form-control" placeholder="Conclui-se que o avaliado apresenta..."></textarea>
                <button class="btn-magic" onclick="improveText('textoConclusao', 'CONCLUSÃO')" title="IA: Conclusão Ética"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <button class="btn-primary" onclick="gerarDocumento()" style="margin-top:30px; width:100%;">
            <i class="fa-solid fa-file-invoice"></i> Gerar Laudo Completo
        </button>

    </div>

    <div id="editorArea" style="max-width: 900px; margin: 0 auto; display:none;">
        
        <div class="card-panel no-print" style="background:#e3f2fd; border:1px solid #90caf9; margin-top:20px; text-align:center;">
            <i class="fa-solid fa-check-circle"></i> Documento pronto. Verifique os dados antes de assinar.
        </div>

        <div id="documentContent" class="doc-preview" contenteditable="true">
            </div>

        <div class="no-print" style="text-align:center; margin-top:30px; margin-bottom:50px;">
            <button class="btn-primary" onclick="window.print()" style="background:#2d3436; display:inline-block; width:auto; padding: 10px 40px;">
                <i class="fa-solid fa-print"></i> Imprimir / PDF
            </button>
            <button class="btn-primary" onclick="voltarEdicao()" style="background:#fff; color:#2d3436; border:1px solid #ccc; display:inline-block; width:auto; padding: 10px 20px;">
                Editar
            </button>
        </div>
    </div>

    <script>
        // CONFIG IA
        if (localStorage.getItem('gemini_api_key')) {
            document.getElementById('status-dot').classList.add('active');
        }

        function configureKey() {
            const key = prompt("Insira sua API Key do Google Gemini:");
            if (key) {
                localStorage.setItem('gemini_api_key', key.trim());
                document.getElementById('status-dot').classList.add('active');
                alert("Chave salva!");
            }
        }

        // FUNÇÃO DE IA
        async function improveText(elementId, sectionType) {
            const textarea = document.getElementById(elementId);
            const originalText = textarea.value;
            const apiKey = localStorage.getItem('gemini_api_key');
            const btn = textarea.nextElementSibling;

            if (!originalText) { alert("Digite o rascunho primeiro."); return; }
            if (!apiKey) { alert("Configure a IA primeiro!"); configureKey(); return; }

            // UI
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.classList.add('loading');

            // Prompts Especializados para Laudo
            let instruction = "";
            if (sectionType === 'DEMANDA') {
                instruction = "Reescreva para 'Descrição da Demanda' de um Laudo Psicológico. Foque nos motivos do encaminhamento e queixas iniciais.";
            } else if (sectionType === 'PROCEDIMENTO') {
                instruction = "Reescreva para 'Procedimento' de um Laudo. Liste as técnicas, instrumentos e número de sessões de forma técnica e organizada.";
            } else if (sectionType === 'ANÁLISE') {
                instruction = "Reescreva para 'Análise' de um Laudo Psicológico. Use terminologia técnica, 3ª pessoa, integre os dados observados e seja fundamentado teoricamente.";
            } else if (sectionType === 'CONCLUSÃO') {
                instruction = "Reescreva para 'Conclusão' de um Laudo. Apresente o desfecho da avaliação, hipóteses diagnósticas (se houver) e encaminhamentos necessários.";
            }

            const prompt = `Atue como um Psicólogo Avaliador (CFP 06/2019). ${instruction} Texto: "${originalText}"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                textarea.value = data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                alert("Erro na IA: " + error.message);
            } finally {
                btn.innerHTML = originalContent;
                btn.classList.remove('loading');
            }
        }

        // GERAÇÃO DO DOC
        function formatarDataExtenso() {
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const data = new Date();
            return `Pelotas, ${data.getDate()} de ${meses[data.getMonth()]} de ${data.getFullYear()}`;
        }

        function nl2br(str) {
            if (!str) return "";
            return str.split('\n').map(p => `<p class="doc-content">${p}</p>`).join('');
        }

        function gerarDocumento() {
            const paciente = document.getElementById('paciente').value;
            const solicitante = document.getElementById('solicitante').value;
            const finalidade = document.getElementById('finalidade').value;
            const demanda = document.getElementById('textoDemanda').value;
            const procedimento = document.getElementById('textoProcedimento').value;
            const analise = document.getElementById('textoAnalise').value;
            const conclusao = document.getElementById('textoConclusao').value;

            if(!paciente || !demanda || !procedimento || !analise || !conclusao) {
                alert("Preencha todos os campos obrigatórios.");
                return;
            }

            const dataHoje = formatarDataExtenso();

            const htmlLaudo = `
                <div class="doc-title">LAUDO PSICOLÓGICO</div>

                <div class="doc-section-title">1. IDENTIFICAÇÃO</div>
                <table class="ident-table">
                    <tr><td class="ident-label">Nome:</td><td>${paciente}</td></tr>
                    <tr><td class="ident-label">Solicitante:</td><td>${solicitante}</td></tr>
                    <tr><td class="ident-label">Finalidade:</td><td>${finalidade}</td></tr>
                    <tr><td class="ident-label">Autor:</td><td>Bruno de Souza Gonçalves (CRP 07/44472)</td></tr>
                </table>

                <div class="doc-section-title">2. DESCRIÇÃO DA DEMANDA</div>
                ${nl2br(demanda)}

                <div class="doc-section-title">3. PROCEDIMENTO</div>
                ${nl2br(procedimento)}

                <div class="doc-section-title">4. ANÁLISE</div>
                ${nl2br(analise)}

                <div class="doc-section-title">5. CONCLUSÃO</div>
                ${nl2br(conclusao)}

                <br><br>
                <p style="text-align: right;">${dataHoje}.</p>

                <div class="signature-section">
                    <div class="signature-line">
                        <b>Bruno de Souza Gonçalves</b><br>
                        Psicólogo Clínico<br>
                        CRP 07/44472
                    </div>
                </div>
            `;

            document.getElementById('documentContent').innerHTML = htmlLaudo;
            document.querySelector('.card-panel').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function voltarEdicao() {
            document.querySelector('.card-panel').style.display = 'block';
            document.getElementById('editorArea').style.display = 'none';
            window.scrollTo(0, 0);
        }

        carregarFooter();
    </script>

</body>
</html>
