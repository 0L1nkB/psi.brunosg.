<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Parecer | CFP</title>
    
    <script>
        if(localStorage.getItem('logado') !== 'sim') {
            window.location.href = "../../../login.html"; 
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="../../../assets/style.css">
    <script src="../../../assets/layout.js"></script>
    <script src="../../../assets/print.js"></script>

    <style>
        /* Estilos do Documento (Visualização e Impressão) */
        .doc-preview {
            background: white;
            border: 1px solid #ccc;
            padding: 80px 60px;
            min-height: 800px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.5;
            color: #000;
            display: none;
            text-align: justify;
        }

        .doc-title {
            text-align: center;
            font-weight: bold;
            font-size: 14pt;
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        .doc-section-title {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 12pt;
        }

        .doc-content {
            margin-bottom: 20px;
            text-indent: 2cm; /* Parágrafo ABNT */
        }

        .signature-section {
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            break-inside: avoid;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 400px;
            padding-top: 10px;
            font-size: 12pt;
        }

        /* Inputs com Botão Mágico */
        .magic-input-wrapper { position: relative; }
        
        .btn-magic {
            position: absolute; bottom: 10px; right: 10px;
            background: var(--primary-color); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0.7; transition: 0.3s;
        }
        .btn-magic:hover { opacity: 1; transform: scale(1.1); }
        .btn-magic.loading { background: #b2bec3; cursor: wait; animation: pulse 1s infinite; }
        
        textarea { min-height: 120px; padding-bottom: 40px; font-family: 'Quicksand', sans-serif; }

        @keyframes pulse { 0% {transform: scale(0.9);} 50% {transform: scale(1.1);} 100% {transform: scale(0.9);} }

        /* Config IA Flutuante */
        .ai-config-float { position: fixed; top: 100px; right: 20px; z-index: 100; }
        .btn-config-ia {
            background: #2d3436; color: white; padding: 8px 15px; border-radius: 30px;
            font-size: 0.8rem; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ff7675; }
        .status-dot.active { background: #00b894; box-shadow: 0 0 5px #00b894; }

        @media (max-width: 1200px) { .ai-config-float { top: auto; bottom: 20px; left: 20px; right: auto; } }

        @media print {
            .no-print, .app-header, .fab, .btn-back-home, .card-panel, .ai-config-float { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            .doc-preview { display: block !important; box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; }
            #editorArea { display: block !important; margin: 0 !important; width: 100% !important; }
        }
    </style>
</head>
<body>

    <script>
        carregarHeader("Gerador de Parecer", "Assistido por IA (Resolução CFP 06/2019)");
    </script>

    <div class="ai-config-float no-print">
        <button class="btn-config-ia" onclick="configureKey()">
            <div class="status-dot" id="status-dot"></div> Configurar IA
        </button>
    </div>

    <div class="card-panel no-print" style="max-width: 900px; margin: 0 auto;">
        
        <h3 style="color:var(--primary-color); margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <i class="fa-solid fa-pen-to-square"></i> Rascunho do Parecer
        </h3>

        <div class="grid-2">
            <div>
                <label class="form-label">Nome do Solicitante/Paciente:</label>
                <input type="text" id="solicitante" class="form-control" placeholder="Nome da pessoa ou instituição">
            </div>
            <div>
                <label class="form-label">Assunto/Finalidade:</label>
                <input type="text" id="assunto" class="form-control" placeholder="Ex: Avaliação para cirurgia bariátrica">
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">I. Descrição da Demanda:</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Rascunhe aqui o motivo do documento. A IA irá formalizar.</div>
            <div class="magic-input-wrapper">
                <textarea id="textoDemanda" class="form-control" placeholder="Ex: O paciente solicitou avaliação psicológica para..."></textarea>
                <button class="btn-magic" onclick="improveText('textoDemanda', 'DEMANDA')" title="Reescrever formalmente"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">II. Análise:</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Descreva suas observações, testes aplicados e fundamentação. A IA irá organizar tecnicamente.</div>
            <div class="magic-input-wrapper">
                <textarea id="textoAnalise" class="form-control" style="min-height:200px;" placeholder="Ex: Foram realizadas 5 sessões. O paciente demonstra ansiedade leve. Testes indicam..."></textarea>
                <button class="btn-magic" onclick="improveText('textoAnalise', 'ANÁLISE')" title="Melhorar linguagem técnica"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label class="form-label">III. Conclusão:</label>
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Qual o resultado final? A IA deixará o texto conclusivo e ético.</div>
            <div class="magic-input-wrapper">
                <textarea id="textoConclusao" class="form-control" placeholder="Ex: O paciente está apto para o procedimento..."></textarea>
                <button class="btn-magic" onclick="improveText('textoConclusao', 'CONCLUSÃO')" title="Formalizar conclusão"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            </div>
        </div>

        <button class="btn-primary" onclick="gerarDocumento()" style="margin-top:30px; width:100%;">
            <i class="fa-solid fa-file-pdf"></i> Visualizar Documento Final
        </button>

    </div>

    <div id="editorArea" style="max-width: 900px; margin: 0 auto; display:none;">
        
        <div class="card-panel no-print" style="background:#e3f2fd; border:1px solid #90caf9; margin-top:20px; text-align:center;">
            <i class="fa-solid fa-check-circle"></i> Documento montado. Revise o texto abaixo e clique em imprimir.
        </div>

        <div id="documentContent" class="doc-preview" contenteditable="true">
            </div>

        <div class="no-print" style="text-align:center; margin-top:30px; margin-bottom:50px;">
            <button class="btn-primary" onclick="window.print()" style="background:#2d3436; display:inline-block; width:auto; padding: 10px 40px;">
                <i class="fa-solid fa-print"></i> Imprimir / PDF
            </button>
            <button class="btn-primary" onclick="voltarEdicao()" style="background:#fff; color:#2d3436; border:1px solid #ccc; display:inline-block; width:auto; padding: 10px 20px;">
                Voltar e Editar
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO DA IA ---
        if (localStorage.getItem('gemini_api_key')) {
            document.getElementById('status-dot').classList.add('active');
        }

        function configureKey() {
            const key = prompt("Insira sua API Key do Google Gemini:");
            if (key) {
                localStorage.setItem('gemini_api_key', key.trim());
                document.getElementById('status-dot').classList.add('active');
                alert("Chave salva!");
            }
        }

        // --- 2. FUNÇÃO DE MELHORIA DE TEXTO (IA) ---
        async function improveText(elementId, sectionType) {
            const textarea = document.getElementById(elementId);
            const originalText = textarea.value;
            const apiKey = localStorage.getItem('gemini_api_key');
            const btn = textarea.nextElementSibling;

            if (!originalText) { alert("Escreva um rascunho primeiro!"); return; }
            if (!apiKey) { alert("Configure a IA primeiro!"); configureKey(); return; }

            // UI Loading
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.classList.add('loading');

            // Prompts Específicos por Seção (CFP)
            let instruction = "";
            if (sectionType === 'DEMANDA') {
                instruction = "Reescreva este texto para a seção 'Descrição da Demanda' de um Parecer Psicológico. Seja objetivo, impessoal e foque no motivo da solicitação.";
            } else if (sectionType === 'ANÁLISE') {
                instruction = "Reescreva este texto para a seção 'Análise' de um Parecer Psicológico. Use linguagem técnica da psicologia, mantenha a impessoalidade (3ª pessoa), seja ético e fundamentado.";
            } else if (sectionType === 'CONCLUSÃO') {
                instruction = "Reescreva este texto para a seção 'Conclusão' de um Parecer Psicológico. Seja conclusivo, direto e responda à demanda inicial sem abrir novas questões.";
            }

            const prompt = `
                Atue como um Supervisor Clínico rigoroso com as normas do CFP (Resolução 06/2019).
                ${instruction}
                Mantenha os dados fáticos, mas melhore a redação para um documento oficial.
                Texto original: "${originalText}"
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                textarea.value = data.candidates[0].content.parts[0].text.trim();

            } catch (error) {
                alert("Erro na IA: " + error.message);
            } finally {
                btn.innerHTML = originalContent;
                btn.classList.remove('loading');
            }
        }

        // --- 3. GERAÇÃO DO DOCUMENTO ---
        function formatarDataExtenso() {
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const data = new Date();
            return `Pelotas, ${data.getDate()} de ${meses[data.getMonth()]} de ${data.getFullYear()}`;
        }

        function nl2br(str) {
            if (!str) return "";
            return str.split('\n').map(p => `<p class="doc-content">${p}</p>`).join('');
        }

        function gerarDocumento() {
            const solicitante = document.getElementById('solicitante').value;
            const assunto = document.getElementById('assunto').value;
            const demanda = document.getElementById('textoDemanda').value;
            const analise = document.getElementById('textoAnalise').value;
            const conclusao = document.getElementById('textoConclusao').value;

            if(!solicitante || !demanda || !analise || !conclusao) {
                alert("Por favor, preencha todos os campos para gerar o documento completo.");
                return;
            }

            const dataHoje = formatarDataExtenso();

            // Montagem do HTML Final
            const htmlParecer = `
                <div class="doc-title">PARECER PSICOLÓGICO</div>

                <div class="doc-section-title">1. IDENTIFICAÇÃO</div>
                <div style="margin-bottom: 20px;">
                    <strong>Solicitante/Paciente:</strong> ${solicitante}<br>
                    <strong>Assunto:</strong> ${assunto}<br>
                    <strong>Autor:</strong> Bruno de Souza Gonçalves (CRP 07/44472)
                </div>

                <div class="doc-section-title">2. DESCRIÇÃO DA DEMANDA</div>
                ${nl2br(demanda)}

                <div class="doc-section-title">3. ANÁLISE</div>
                ${nl2br(analise)}

                <div class="doc-section-title">4. CONCLUSÃO</div>
                ${nl2br(conclusao)}

                <br><br>
                <p style="text-align: right;">${dataHoje}.</p>

                <div class="signature-section">
                    <div class="signature-line">
                        <b>Bruno de Souza Gonçalves</b><br>
                        Psicólogo Clínico<br>
                        CRP 07/44472
                    </div>
                </div>
            `;

            document.getElementById('documentContent').innerHTML = htmlParecer;
            
            document.querySelector('.card-panel').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function voltarEdicao() {
            document.querySelector('.card-panel').style.display = 'block';
            document.getElementById('editorArea').style.display = 'none';
            window.scrollTo(0, 0);
        }

        carregarFooter();
    </script>

</body>
</html>
