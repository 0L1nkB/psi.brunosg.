<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroView - Magnum Opus v17</title>
    <style>
        :root { 
            --accent: #00f3ff;           
            --accent-chem: #ff00ea;      
            --accent-path: #ffae00;      
            --accent-net: #00ff88;       
            
            --bg-color: #121214; 
            --panel-bg: rgba(20, 22, 28, 0.96); 
            --text-main: #ffffff;
            --text-sec: #aaaaaa;
            --border: rgba(255,255,255,0.1);
            --shadow: rgba(0,0,0,0.6);
        }

        /* TEMA CLARO */
        body.light-mode {
            --accent: #0051ff;
            --accent-chem: #cc00bd;
            --accent-path: #d97700;
            --accent-net: #009955;
            --bg-color: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.98);
            --text-main: #1a1a1a;
            --text-sec: #555555;
            --border: rgba(0,0,0,0.1);
            --shadow: rgba(0,0,0,0.15);
        }

        body { margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Segoe UI', Roboto, sans-serif; color: var(--text-main); user-select: none; transition: background 0.3s; }
        
        /* HEADER */
        .top-bar {
            position: absolute; top: 15px; right: 15px; z-index: 200; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; width: auto;
        }
        .icon-btn {
            background: var(--panel-bg); border: 1px solid var(--border);
            color: var(--text-main); width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 18px; box-shadow: 0 4px 12px var(--shadow); transition: all 0.2s ease;
        }
        .icon-btn:hover { transform: scale(1.1); }
        
        .icon-btn.active-anat { background: var(--accent); color: #000; border-color: var(--accent); }
        .icon-btn.active-chem { background: var(--accent-chem); color: #fff; border-color: var(--accent-chem); }
        .icon-btn.active-path { background: var(--accent-path); color: #000; border-color: var(--accent-path); }
        .icon-btn.active-net { background: var(--accent-net); color: #000; border-color: var(--accent-net); }

        /* LOADING */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 1000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.5s;
        }
        .bar-container { width: 300px; height: 4px; background: #333; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; }
        
        /* PAINEL INFO */
        #info {
            position: absolute; top: 80px; right: 20px; width: 320px;
            background: var(--panel-bg); border-right: 4px solid var(--accent);
            padding: 25px; border-radius: 12px; z-index: 20;
            box-shadow: -10px 10px 50px var(--shadow);
            transform: translateX(450px); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            backdrop-filter: blur(10px); max-height: calc(100vh - 120px); overflow-y: auto;
        }
        #info.active { transform: translateX(0); }
        
        #info h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; line-height: 1.1; }
        #info h3 { margin: 8px 0 15px 0; font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        #info p { font-size: 14px; line-height: 1.6; color: var(--text-sec); margin-bottom: 20px; }
        
        /* Context Box Din√¢mico */
        .context-box { 
            background: rgba(255, 255, 255, 0.05); border-left: 3px solid #fff; 
            padding: 12px; font-size: 13px; color: var(--text-main); border-radius: 0 4px 4px 0; margin-top: 15px; 
            display: none;
        }
        .context-title { font-weight: 800; text-transform: uppercase; font-size: 10px; display: block; margin-bottom: 5px; opacity: 0.8;}

        /* MENU LATERAL */
        #menu {
            position: absolute; top: 20px; left: 20px; width: 280px; max-height: 85vh;
            background: var(--panel-bg); border-radius: 12px; border: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20; box-shadow: 0 4px 20px var(--shadow);
        }
        .menu-head { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .menu-title { font-size: 12px; color: var(--text-sec); font-weight: 800; text-transform: uppercase; letter-spacing: 1px;}
        
        .bulk-btn { 
            background: rgba(128,128,128,0.1); border: 1px solid var(--border); 
            color: var(--text-sec); font-size: 9px; padding: 5px 10px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; transition: 0.2s; 
        }
        .bulk-btn:hover { background: var(--accent); color: #fff; }

        .menu-list { flex: 1; overflow-y: auto; padding: 5px; scrollbar-width: thin; }
        
        .menu-row {
            display: flex; align-items: center; padding: 8px 10px; margin-bottom: 2px;
            border-radius: 6px; transition: 0.2s; cursor: pointer;
        }
        .menu-row:hover { background: rgba(128,128,128,0.1); }
        .menu-row.selected { background: rgba(0, 243, 255, 0.1); border-right: 3px solid var(--accent); }
        
        /* Cores de Sele√ß√£o */
        .chem-mode .menu-row.selected { background: rgba(255, 0, 234, 0.15); border-right-color: var(--accent-chem); }
        .path-mode .menu-row.selected { background: rgba(255, 174, 0, 0.15); border-right-color: var(--accent-path); }
        .net-mode .menu-row.selected { background: rgba(0, 255, 136, 0.15); border-right-color: var(--accent-net); }
        
        .chem-mode #info { border-right-color: var(--accent-chem); }
        .chem-mode #info h3 { color: var(--accent-chem); }
        .chem-mode .context-box { border-left-color: var(--accent-chem); background: rgba(255,0,234,0.1); }

        .path-mode #info { border-right-color: var(--accent-path); }
        .path-mode #info h3 { color: var(--accent-path); }
        .path-mode .context-box { border-left-color: var(--accent-path); background: rgba(255,174,0,0.1); }

        .net-mode #info { border-right-color: var(--accent-net); }
        .net-mode #info h3 { color: var(--accent-net); }
        .net-mode .context-box { border-left-color: var(--accent-net); background: rgba(0,255,136,0.1); }

        .menu-row.hidden-layer { opacity: 0.4; filter: grayscale(1); }

        .chk-wrapper { width: 30px; display: flex; align-items: center; }
        .chk { width: 14px; height: 14px; cursor: pointer; accent-color: var(--accent); }
        
        .menu-label { flex: 1; font-size: 12px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; padding-left: 5px;}
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }

        /* CONTROLES */
        #controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--panel-bg); padding: 12px 30px; border-radius: 40px;
            border: 1px solid var(--border); display: flex; gap: 40px; align-items: center; z-index: 20;
            box-shadow: 0 10px 30px var(--shadow);
        }
        .ctrl-group { display: flex; flex-direction: column; align-items: center; }
        .ctrl-label { font-size: 9px; color: var(--text-sec); text-transform: uppercase; font-weight: bold; margin-bottom: 6px; }
        input[type=range] { width: 120px; accent-color: var(--accent); cursor: pointer; }
        
        .view-opts { display: flex; gap: 4px; background: rgba(128,128,128,0.1); padding: 4px; border-radius: 20px; }
        .view-btn { background: none; border: none; color: var(--text-sec); padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 15px; font-weight: bold; transition: 0.2s;}
        .view-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

        #tooltip {
            position: absolute; pointer-events: none; background: var(--panel-bg); border: 1px solid var(--border);
            color: var(--text-main); padding: 6px 12px; border-radius: 4px; font-size: 11px; display: none; z-index: 50;
            box-shadow: 0 4px 10px var(--shadow); font-weight: bold;
        }

        @media (max-width: 768px) {
            #menu { left: -320px; transition: 0.3s; height: 100vh; top: 0; width: 85%; border-radius: 0; }
            #menu.open { transform: translateX(320px); }
            #info { top: auto; bottom: 0; right: 0; left: 0; width: 100%; border-radius: 20px 20px 0 0; transform: translateY(120%); max-height: 60vh;}
            #info.active { transform: translateY(0); }
            #controls { width: 90%; gap: 15px; padding: 15px; }
            .top-bar { top: 10px; right: 10px; gap: 8px; width: auto; flex-direction: row; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-weight: 800; font-size: 24px; color: var(--text-main); letter-spacing: 3px;">NEURO<span style="color:var(--accent)">VIEW</span></div>
        <div style="font-size: 11px; color: var(--text-sec); margin-top: 5px;">MAGNUM OPUS EDITION</div>
        <div class="bar-container"><div class="bar-fill" id="progress"></div></div>
    </div>

    <div class="top-bar">
        <button id="net-toggle" class="icon-btn" onclick="toggleMode('net')" title="Redes Neurais">üåê</button>
        <button id="path-toggle" class="icon-btn" onclick="toggleMode('path')" title="Psicopatologia">‚ò£Ô∏è</button>
        <button id="chem-toggle" class="icon-btn" onclick="toggleMode('chem')" title="Neurotransmissores">üß™</button>
        <button id="anat-toggle" class="icon-btn active-anat" onclick="toggleMode('anat')" title="Anatomia">üß†</button>
        <button id="theme-toggle" class="icon-btn" onclick="toggleTheme()" title="Mudar Tema">‚òÄ</button>
        <button class="icon-btn" onclick="toggleMenuMobile()" style="font-size: 16px;">‚ò∞</button>
    </div>

    <div id="tooltip"></div>

    <div id="menu">
        <div class="menu-head">
            <span class="menu-title" id="menu-title">Estruturas</span>
            <div class="bulk-actions" id="bulk-actions">
                <div class="bulk-btn" onclick="toggleAll(true)">VER TUDO</div>
                <div class="bulk-btn" onclick="toggleAll(false)">LIMPAR</div>
            </div>
        </div>
        <div class="menu-list" id="menu-content"></div>
    </div>

    <div id="info">
        <h2 id="info-name">...</h2>
        <h3 id="info-func">...</h3>
        <p id="info-desc">...</p>
        <div id="context-box" class="context-box">
            <span class="context-title" id="context-title">...</span>
            <span id="context-text">...</span>
        </div>
    </div>

    <div id="controls">
        <div class="ctrl-group">
            <div class="ctrl-label">Expans√£o</div>
            <input type="range" id="explode" min="0" max="1" step="0.001" value="0">
        </div>
        <div class="ctrl-group">
            <div class="ctrl-label">Visualiza√ß√£o</div>
            <div class="view-opts">
                <button class="view-btn" onclick="setHemisphere(-1)">ESQ</button>
                <button class="view-btn active" onclick="setHemisphere(0)">FULL</button>
                <button class="view-btn" onclick="setHemisphere(1)">DIR</button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        // --- 1. DADOS ANAT√îMICOS ---
        const anatMap = {
            "prefrontal": { name: "C√≥rtex Pr√©-Frontal", func: "Executivo Central", desc: "Planejamento, personalidade e controle de impulsos.", color: 0x00FFFF, clinical: "Les√µes: Impulsividade, mudan√ßa de personalidade (Caso Phineas Gage).", keywords: ["superior frontal", "middle frontal", "straight", "rectus", "orbital"] },
            "motor": { name: "C√≥rtex Motor", func: "Movimento", desc: "Controle muscular volunt√°rio.", color: 0xFF2A2A, clinical: "Les√µes: Paralisia do lado oposto do corpo.", keywords: ["precentral"] },
            "somato": { name: "C√≥rtex Somatossensorial", func: "Sensa√ß√£o", desc: "Processa tato, dor e temperatura.", color: 0xFFA500, clinical: "Les√µes: Perda de sensibilidade t√°til.", keywords: ["postcentral"] },
            "broca": { name: "√Årea de Broca", func: "Fala", desc: "Produ√ß√£o da linguagem.", color: 0x9D00FF, clinical: "Afasia de Broca: Fala lenta e dif√≠cil, compreens√£o preservada.", keywords: ["inferior frontal"] },
            "wernicke": { name: "√Årea de Wernicke", func: "Compreens√£o", desc: "Entendimento da linguagem.", color: 0x0088FF, clinical: "Afasia de Wernicke: Fala fluente sem sentido.", keywords: ["supramarginal", "angular", "posterior transverse"] },
            "auditory": { name: "C√≥rtex Auditivo", func: "Audi√ß√£o", desc: "Processamento de sons.", color: 0x76FF03, keywords: ["transverse temporal", "superior temporal"] },
            "fusiform": { name: "Giro Fusiforme", func: "Face", desc: "Reconhecimento de rostos.", color: 0xFF0055, clinical: "Prosopagnosia: Cegueira para rostos.", keywords: ["fusiform"] },
            "uncus": { name: "Uncus", func: "Olfato", desc: "Cheiro e emo√ß√£o.", color: 0xFF4081, clinical: "Crises epil√©pticas uncinadas (cheiros fantasmas).", keywords: ["uncus"] },
            "hippocampus": { name: "Hipocampo", func: "Mem√≥ria", desc: "Consolida√ß√£o de mem√≥rias novas.", color: 0xFFEA00, clinical: "Caso HM: Amn√©sia anter√≥grada total.", keywords: ["hippocampus", "dentate", "fimbria", "subiculum", "fasciolar"] },
            "amygdala": { name: "Am√≠gdala", func: "Emo√ß√£o", desc: "Processamento de medo e amea√ßa.", color: 0xFF0000, clinical: "S√≠ndrome de Kl√ºver-Bucy: Perda total de medo.", keywords: ["amygdala", "periamygdaloid"] },
            "insula": { name: "√çnsula", func: "Interocep√ß√£o", desc: "Sensa√ß√£o interna e empatia.", color: 0xD500F9, keywords: ["short gyrus of insula", "long gyrus of insula", "insula", "anterior accessory"] },
            "cingulate": { name: "C√≥rtex Cingulado", func: "Conflito", desc: "Regula√ß√£o emocional.", color: 0x1DE9B6, keywords: ["cingulate"] },
            "thalamus": { name: "T√°lamo", func: "Rel√©", desc: "Hub sensorial.", color: 0x304FFE, keywords: ["thalamus", "geniculate", "pulvinar", "ventral posterior", "ventral lateral", "medial dorsal", "anterior nucleus", "centromedian", "parafascicular", "paratenial", "reuniens"] },
            "hypothalamus": { name: "Hipot√°lamo", func: "Homeostase", desc: "Fun√ß√µes vitais.", color: 0xF50057, keywords: ["hypothalamus", "mammillary", "preoptic", "suprachiasmatic", "supraoptic", "tuber cinereum", "posterior nucleus", "arcuate"] },
            "basal": { name: "N√∫cleos da Base", func: "H√°bito", desc: "Motor fino e h√°bito.", color: 0x6200EA, keywords: ["caudate", "putamen", "globus pallidus", "accumbens", "subthalamic", "substantia nigra", "claustrum"] },
            "brainstem": { name: "Tronco", func: "Vital", desc: "Respira√ß√£o e cora√ß√£o.", color: 0xFFFFFF, keywords: ["midbrain", "pons", "medulla", "oblongata", "colliculus", "nigra"] },
            "cerebellum": { name: "Cerebelo", func: "Equil√≠brio", desc: "Coordena√ß√£o.", color: 0xFFD600, keywords: ["cerebellum"] },
            "connect": { name: "Subst√¢ncia Branca", func: "Conex√£o", desc: "Vias de comunica√ß√£o.", color: 0x607D8B, keywords: ["callosum", "capsule", "corona", "fornix", "tract"] },
            "ventricle": { name: "Ventr√≠culos", func: "LCR", desc: "Prote√ß√£o flu√≠da.", color: 0x00E5FF, keywords: ["ventricle", "aqueduct", "choroid"] },
            "temporal_inf": { name: "Temporal Inferior", func: "Visual", desc: "Objetos.", color: 0x00E676, keywords: ["inferior temporal", "middle temporal"] },
            "occipital": { name: "Lobo Occipital", func: "Vis√£o", desc: "Processamento visual.", color: 0xD50000, keywords: ["occipital", "cuneus", "lingual", "calcarine"] },
            "parietal_assoc": { name: "Parietal Assoc.", func: "Espa√ßo", desc: "Orienta√ß√£o.", color: 0xFFC400, keywords: ["superior parietal", "precuneus"] },
            "parahippocampal": { name: "Giro Parahipocampal", func: "Cenas", desc: "Mem√≥ria espacial.", color: 0xF8BBD0, keywords: ["parahippocampal", "entorhinal"] },
            "olfactory": { name: "Sistema Olfat√≥rio", func: "Olfato", desc: "Tratos olfat√≥rios.", color: 0x00C853, keywords: ["olfactory"] },
            "epithalamus": { name: "Epit√°lamo", func: "Sono", desc: "Pineal.", color: 0x90CAF9, keywords: ["habenula", "pineal"] }
        };

        // --- 2. NEUROQU√çMICA ---
        const chemMap = {
            "dopamine": { name: "Dopamina", func: "Prazer & Motor", color: 0x00E5FF, desc: "A 'mol√©cula da motiva√ß√£o'. Regula prazer, recompensa e controle motor.", targets: { "prefrontal": "Receptores D1 essenciais para mem√≥ria de trabalho e foco.", "basal": "Estriado (Accumbens): Centro de prazer e refor√ßo.", "brainstem": "VTA e Subst√¢ncia Negra: F√°bricas de Dopamina.", "hippocampus": "Marca mem√≥rias como 'importantes' para o aprendizado." } },
            "serotonin": { name: "Serotonina", func: "Humor & Sono", color: 0xFF00FF, desc: "Estabiliza o humor, bem-estar e o ciclo do sono.", targets: { "brainstem": "N√∫cleos da Rafe: Local de produ√ß√£o.", "amygdala": "Regula a resposta de ansiedade.", "prefrontal": "Modula o humor e a impulsividade.", "hippocampus": "Estimula a neurog√™nese e plasticidade.", "cingulate": "Processamento emocional." } },
            "noradrenaline": { name: "Noradrenalina", func: "Alerta & Foco", color: 0xFFA500, desc: "Prepara o c√©rebro para a√ß√£o (Luta ou Fuga).", targets: { "brainstem": "Locus Coeruleus: Fonte principal.", "amygdala": "Aumenta a codifica√ß√£o de mem√≥rias emocionais.", "prefrontal": "Melhora o foco sustentado.", "parietal_assoc": "Vigil√¢ncia espacial." } },
            "gaba": { name: "GABA", func: "Inibi√ß√£o", color: 0x00FF00, desc: "Principal neurotransmissor inibit√≥rio. 'Freia' o c√©rebro.", targets: { "cerebellum": "C√©lulas de Purkinje refinam movimento.", "basal": "Freia movimentos indesejados.", "prefrontal": "Controle da ansiedade.", "occipital": "Refinamento visual." } },
            "glutamate": { name: "Glutamato", func: "Excita√ß√£o", color: 0xFFD700, desc: "Principal excitat√≥rio. Vital para mem√≥ria (LTP).", targets: { "hippocampus": "Base da plasticidade sin√°ptica.", "prefrontal": "Comunica√ß√£o r√°pida.", "motor": "Envio de sinal motor.", "thalamus": "Transmiss√£o sensorial." } },
            "oxytocin": { name: "Ocitocina", func: "V√≠nculo Social", color: 0xFF69B4, desc: "Horm√¥nio do amor, confian√ßa e v√≠nculo.", targets: { "hypothalamus": "Produ√ß√£o e libera√ß√£o.", "amygdala": "Reduz a reatividade ao medo.", "basal": "Nucleus Accumbens: Recompensa social." } },
            "endorphin": { name: "Endorfinas", func: "Analgesia", color: 0xFFFFFF, desc: "Al√≠vio da dor e euforia natural.", targets: { "brainstem": "Subst√¢ncia Cinzenta Periaquedutal (PAG).", "thalamus": "Bloqueio do sinal de dor.", "basal": "Sensa√ß√£o de prazer." } },
            "cortisol": { name: "Cortisol", func: "Estresse", color: 0xA1887F, desc: "Horm√¥nio do estresse. T√≥xico em excesso.", targets: { "hippocampus": "Atrofia dendr√≠tica (dano √† mem√≥ria).", "amygdala": "Hipertrofia (aumento do medo).", "prefrontal": "Dano √† fun√ß√£o executiva." } },
            "adenosine": { name: "Adenosina", func: "Fadiga", color: 0x546E7A, desc: "Acumula durante o dia causando press√£o de sono.", targets: { "basal": "Inibe a excita√ß√£o motora.", "prefrontal": "Reduz a vigil√¢ncia cognitiva." } },
            "substance_p": { name: "Subst√¢ncia P", func: "Dor", color: 0xB71C1C, desc: "Transmiss√£o de sinais de dor intensa.", targets: { "brainstem": "Medula e PAG.", "amygdala": "Aspecto emocional da dor.", "cingulate": "Sofrimento associado √† dor." } }
        };

        // --- 3. PSICOPATOLOGIA ---
        const pathMap = {
            "adhd": { name: "TDAH", func: "Aten√ß√£o", color: 0xF39C12, desc: "Disfun√ß√£o executiva e de dopamina.", targets: { "prefrontal": "Hipoatividade: Dificuldade de inibir distra√ß√µes.", "basal": "Disfun√ß√£o dopamin√©rgica: Falha no controle.", "cerebellum": "Atraso na matura√ß√£o (timing)." } },
            "depression": { name: "Depress√£o Maior", func: "Humor", color: 0x2E86C1, desc: "Transtorno de humor e anedonia.", targets: { "prefrontal": "Hipoatividade esquerda (falta de iniciativa).", "hippocampus": "Redu√ß√£o de volume (estresse cr√¥nico).", "amygdala": "Hiperatividade (rumina√ß√£o).", "cingulate": "Dor emocional." } },
            "anxiety": { name: "Ansiedade", func: "Medo", color: 0xE74C3C, desc: "Amea√ßa desproporcional.", targets: { "amygdala": "Dispara alarmes falsos.", "prefrontal": "Incapaz de acalmar a am√≠gdala.", "insula": "Hipersensibilidade f√≠sica." } },
            "bipolar": { name: "Bipolaridade", func: "Oscila√ß√£o", color: 0x8E44AD, desc: "Mania vs Depress√£o.", targets: { "prefrontal": "Dano no controle na mania.", "amygdala": "Instabilidade emocional.", "thalamus": "Filtro sensorial alterado." } },
            "schizo": { name: "Esquizofrenia", func: "Psicose", color: 0x7D3C98, desc: "Perda de realidade.", targets: { "prefrontal": "Sintomas negativos (apatia).", "basal": "Excesso de dopamina: Alucina√ß√µes.", "ventricle": "Alargamento ventricular.", "hippocampus": "Desorganiza√ß√£o." } },
            "alzheimer": { name: "Alzheimer", func: "Neurodegenera√ß√£o", color: 0x95A5A6, desc: "Perda de mem√≥ria.", targets: { "hippocampus": "Atrofia inicial (mem√≥ria recente).", "parahippocampal": "Desorienta√ß√£o espacial.", "temporal_inf": "Perda de reconhecimento.", "prefrontal": "Perda cognitiva tardia." } },
            "parkinson": { name: "Parkinson", func: "Motor", color: 0x34495E, desc: "Degenera√ß√£o motora.", targets: { "brainstem": "Morte da Subst√¢ncia Negra.", "basal": "Travamento do circuito motor.", "motor": "Dificuldade de inicia√ß√£o." } },
            "toc": { name: "TOC", func: "Obsess√£o", color: 0x16A085, desc: "Pensamentos intrusivos.", targets: { "prefrontal": "C√≥rtex Orbitofrontal: 'Algo est√° errado'.", "cingulate": "Ansiedade de erro.", "basal": "Loop compulsivo." } },
            "ptsd": { name: "TEPT", func: "Trauma", color: 0x5D4037, desc: "Falha na extin√ß√£o do medo.", targets: { "amygdala": "Hiper-responsiva a gatilhos.", "hippocampus": "Incapaz de contextualizar (flashbacks).", "prefrontal": "Falha na supress√£o." } },
            "borderline": { name: "Borderline", func: "Instabilidade", color: 0xFF0055, desc: "Desregula√ß√£o emocional severa.", targets: { "amygdala": "Reatividade extrema.", "prefrontal": "Desconex√£o com o sistema l√≠mbico.", "cingulate": "Dor da rejei√ß√£o." } },
            "anorexia": { name: "Anorexia", func: "Imagem", color: 0x00BCD4, desc: "Distor√ß√£o corporal e controle.", targets: { "insula": "Distor√ß√£o da imagem corporal.", "basal": "H√°bito r√≠gido de restri√ß√£o.", "parietal_assoc": "Imagem corporal.", "prefrontal": "Controle inibit√≥rio excessivo." } },
            "dyslexia": { name: "Dislexia", func: "Leitura", color: 0xCDDC39, desc: "Dificuldade de processamento fonol√≥gico.", targets: { "wernicke": "Processamento da palavra.", "temporal_inf": "√Årea da forma visual da palavra.", "parietal_assoc": "Mapeamento som-letra." } },
            "epilepsy": { name: "Epilepsia (LTM)", func: "Descarga", color: 0xFFFF00, desc: "Focos no lobo temporal.", targets: { "hippocampus": "Esclerose mesial.", "amygdala": "Aura de medo.", "uncus": "Aura olfativa." } },
            "autism": { name: "Autismo (TEA)", func: "Desenvolvimento", color: 0x76FF03, desc: "Comunica√ß√£o social at√≠pica.", targets: { "cerebellum": "Disfun√ß√£o purkinje.", "amygdala": "Processamento de faces.", "prefrontal": "Teoria da Mente.", "fusiform": "Hiporresponsividade a rostos." } }
        };

        // --- 4. REDES NEURAIS ---
        const netMap = {
            "dmn": { name: "Rede Modo Padr√£o", func: "Repouso/Eu", color: 0x00FF88, desc: "Devaneio e autorreflex√£o.", targets: { "prefrontal": "Medial: Self.", "cingulate": "Posterior: Mem√≥ria.", "parietal_assoc": "Integra√ß√£o.", "temporal_inf": "Sem√¢ntica." } },
            "salience": { name: "Rede de Sali√™ncia", func: "Alerta", color: 0xFF0055, desc: "Detecta relev√¢ncia e troca redes.", targets: { "insula": "Estado do corpo.", "cingulate": "Anterior: Conflito/A√ß√£o." } },
            "central": { name: "Rede Executiva", func: "Foco Externo", color: 0x0088FF, desc: "Resolu√ß√£o de problemas.", targets: { "prefrontal": "Dorsolateral: Mem√≥ria trabalho.", "parietal_assoc": "Aten√ß√£o." } },
            "dorsal_att": { name: "Aten√ß√£o Dorsal", func: "Foco Volunt√°rio", color: 0xFFD700, desc: "Aten√ß√£o 'Top-Down' sustentada.", targets: { "parietal_assoc": "Sulco Intraparietal.", "motor": "Campos Oculares Frontais." } },
            "visual_net": { name: "Rede Visual", func: "Vis√£o", color: 0xD50000, desc: "Processamento visual completo.", targets: { "occipital": "V1/V2.", "temporal_inf": "Ventral (O qu√™).", "parietal_assoc": "Dorsal (Onde)." } },
            "limbic_net": { name: "Rede L√≠mbica", func: "Emo√ß√£o", color: 0xFF0000, desc: "Processamento emocional.", targets: { "amygdala": "Emo√ß√£o.", "hippocampus": "Mem√≥ria.", "prefrontal": "Orbitofrontal: Val√™ncia." } }
        };

        const defaultRegion = { name: "Estrutura", func: "Anatomia", desc: "Estrutura anat√¥mica.", color: 0x444444 };
        
        // Keywords Globais
        const globalKeywords = {};
        Object.keys(anatMap).forEach(k => globalKeywords[k] = anatMap[k].keywords || []);
        globalKeywords["thalamus"] = ["thalamus", "geniculate", "pulvinar", "ventral posterior"];
        globalKeywords["hypothalamus"] = ["hypothalamus", "mammillary", "preoptic", "suprachiasmatic", "tuber cinereum"];
        globalKeywords["brainstem"] = ["midbrain", "pons", "medulla", "oblongata", "colliculus", "nigra", "red nucleus", "cerebral crus"];
        globalKeywords["connect"] = ["corpus callosum", "capsule", "corona", "fornix", "tract", "commissure", "stria", "radiation", "tapetum"];
        globalKeywords["ventricle"] = ["ventricle", "aqueduct"];
        globalKeywords["uncus"] = ["uncus"];
        globalKeywords["parahippocampal"] = ["parahippocampal", "entorhinal", "presubiculum"];
        globalKeywords["insula"] = ["insula"];
        globalKeywords["occipital"] = ["occipital", "cuneus", "lingual", "calcarine"];
        globalKeywords["temporal_inf"] = ["inferior temporal", "middle temporal"];
        globalKeywords["parietal_assoc"] = ["superior parietal", "precuneus"];
        globalKeywords["cerebellum"] = ["cerebellum"]; 

        const fileList = ["FJ1735_BP37293_FMA73462_Brachium of left superior colliculus.obj","FJ1761_BP37183_FMA73464_Brachium of left inferior colliculus.obj","FJ1762_BP35181_FMA73435_Left inferior colliculus.obj","FJ1809_BP33232_FMA73463_Brachium of right inferior colliculus.obj","FJ1810_BP36436_FMA73434_Right inferior colliculus.obj","FJ1815_BP33292_FMA74877_Mammillary body.obj","FJ1826_BP36657_FMA73422_Right superior colliculus.obj","FJ3787_BP35443_FMA78454_Third ventricle.obj","FJ3788_BP35489_FMA78469_Fourth ventricle.obj","FJ3792_BP33376_FMA61961_Anterior commissure.obj","FJ3793_BP33229_FMA73461_Brachium of right superior colliculus.obj","FJ3795_BP33936_FMA78467_Cerebral aqueduct.obj","FJ3798_BP35453_FMA61970_Commissure of fornix of forebrain.obj","FJ3799_BP33365_FMA86464_Corpus callosum.obj","FJ3800_BP37280_FMA62032_Habenula.obj","FJ3801_BP36185_FMA72658_Left inferior frontal gyrus.obj","FJ3802_BP35284_FMA72657_Right inferior frontal gyrus.obj","FJ3807_BP36507_FMA72907_Left internal capsule.obj","FJ3808_BP36506_FMA72906_Right internal capsule.obj","FJ3814_BP35571_FMA72831_Left globus pallidus.obj","FJ3817_BP33711_FMA62008_Hypothalamus.obj","FJ3819_BP33096_FMA61975_Lamina terminalis.obj","FJ3822_BP33292_FMA74877_Mammillary body.obj","FJ3823_BP33849_FMA62004_Medulla oblongata.obj","FJ3824_BP34150_FMA61993_Midbrain.obj","FJ3827_BP33093_FMA242162_Left cerebral crus.obj","FJ3828_BP33675_FMA67943_Pons.obj","FJ3829_BP36782_FMA72829_Left putamen.obj","FJ3830_BP33199_FMA73414_Left stria medullaris of thalamus.obj","FJ3831_BP36885_FMA72940_Left stria terminalis.obj","FJ3832_BP33747_FMA73423_Left superior colliculus.obj","FJ3833_BP37238_FMA62327_Tuber cinereum.obj","FJ3834_BP37207_FMA67944_Cerebellum.obj","FJ3839_BP35281_FMA72656_Left middle frontal gyrus.obj","FJ3840_BP36251_FMA72655_Right middle frontal gyrus.obj","FJ3847_BP33976_FMA62033_Pineal body.obj","FJ3849_BP36774_FMA72666_Left postcentral gyrus.obj","FJ3850_BP37078_FMA72665_Right postcentral gyrus.obj","FJ3851_BP33349_FMA62072_Posterior commissure.obj","FJ3852_BP36414_FMA72662_Left precentral gyrus.obj","FJ3853_BP36698_FMA72661_Right precentral gyrus.obj","FJ3857_BP36976_FMA72830_Right globus pallidus.obj","FJ3860_BP33711_FMA62008_Hypothalamus.obj","FJ3861_BP33096_FMA61975_Lamina terminalis.obj","FJ3865_BP34150_FMA61993_Midbrain.obj","FJ3868_BP36519_FMA242160_Right cerebral crus.obj","FJ3869_BP33675_FMA67943_Pons.obj","FJ3870_BP37053_FMA72828_Right putamen.obj","FJ3871_BP36970_FMA73413_Right stria medullaris of thalamus.obj","FJ3872_BP35487_FMA72939_Right stria terminalis.obj","FJ3874_BP37238_FMA62327_Tuber cinereum.obj","FJ3876_BP37207_FMA67944_Cerebellum.obj","FJ3877_BP33849_FMA62004_Medulla oblongata.obj","FJ3878_BP33625_FMA61842_Septum of telencephalon.obj","FJ3879_BP36418_FMA72654_Left superior frontal gyrus.obj","FJ3880_BP36474_FMA72653_Right superior frontal gyrus.obj","FJ7465_BP37135_FMA256200_Left anterior orbital gyrus.obj","FJ7465M_BP36969_FMA256198_Right anterior orbital gyrus.obj","FJ7466_BP37231_FMA72757_Left lateral orbital gyrus.obj","FJ7466M_BP37236_FMA72756_Right lateral orbital gyrus.obj","FJ7480_BP33949_FMA73491_Right red nucleus.obj","FJ7480M_BP32577_FMA73492_Left red nucleus.obj","FJ7481_BP36510_FMA73539_Right substantia nigra.obj","FJ7481M_BP36509_FMA73540_Left substantia nigra.obj","FJ7482_BP34009_FMA73367_Right subthalamic nucleus.obj","FJ7482M_BP32538_FMA73368_Left subthalamic nucleus.obj","FJ7506_BP33951_FMA73338_Left arcuate nucleus of hypothalamus.obj","FJ7507_BP34023_FMA73337_Right arcuate nucleus of hypothalamus.obj","FJ7508_BP33731_FMA73334_Left anterior nucleus of hypothalamus.obj","FJ7508M_BP33730_FMA73333_Right anterior nucleus of hypothalamus.obj","FJ7509_BP33954_FMA73340_Left dorsomedial nucleus of hypothalamus.obj","FJ7509M_BP32537_FMA73339_Right dorsomedial nucleus of hypothalamus.obj","FJ7510_BP33132_FMA73328_Left lateral preoptic nucleus.obj","FJ7510M_BP33066_FMA73327_Right lateral preoptic nucleus.obj","FJ7511_BP33146_FMA73326_Left medial preoptic nucleus.obj","FJ7511M_BP36650_FMA73325_Right medial preoptic nucleus.obj","FJ7512_BP32541_FMA73336_Left paraventricular nucleus of hypothalamus.obj","FJ7512M_BP34336_FMA73335_Right paraventricular nucleus of hypothalamus.obj","FJ7513_BP33735_FMA73354_Left posterior nucleus of hypothalamus.obj","FJ7513M_BP34017_FMA73353_Right posterior nucleus of hypothalamus.obj","FJ7514_BP34021_FMA73329_Right suprachiasmatic nucleus.obj","FJ7514M_BP34018_FMA73330_Left suprachiasmatic nucleus.obj","FJ7515_BP34020_FMA73331_Right supraoptic nucleus.obj","FJ7515M_BP34299_FMA73332_Left supraoptic nucleus.obj","FJ7516_BP32567_FMA73342_Left ventromedial nucleus of hypothalamus.obj","FJ7516M_BP33952_FMA73341_Right ventromedial nucleus of hypothalamus.obj","FJ7526_BP36645_FMA223162_Left olfactory tract.obj","FJ7526M_BP36644_FMA223163_Right olfactory tract.obj","FJ7528_BP36659_FMA72660_Left straight gyrus.obj","FJ7528M_BP36789_FMA72659_Right straight gyrus.obj","FJ7529_BP33887_FMA72849_Left subcallosal area.obj","FJ7530_BP33090_FMA72708_Left paraterminal gyrus.obj","FJ7530M_BP33088_FMA72707_Right paraterminal gyrus.obj","FJ7533_BP33741_FMA72983_Left anterodorsal nucleus.obj","FJ7533M_BP33737_FMA72982_Right anterodorsal nucleus.obj","FJ7534_BP32554_FMA72985_Left anteromedial nucleus.obj","FJ7534M_BP34015_FMA72984_Right anteromedial nucleus.obj","FJ7535_BP33710_FMA72987_Left anteroventral nucleus.obj","FJ7535M_BP33708_FMA72986_Right anteroventral nucleus.obj","FJ7536_BP34412_FMA73046_Left centromedian nucleus.obj","FJ7536M_BP36651_FMA73045_Right centromedian nucleus.obj","FJ7539_BP35623_FMA73304_Left lateral geniculate body.obj","FJ7539M_BP36971_FMA73303_Right lateral geniculate body.obj","FJ7540_BP33157_FMA73008_Parvicellular part of left medial dorsal nucleus.obj","FJ7540M_BP33151_FMA73006_Parvicellular part of right medial dorsal nucleus.obj","FJ7541_BP33153_FMA73001_Paralaminar part of left medial dorsal nucleus.obj","FJ7541M_BP33154_FMA73000_Paralaminar part of right medial dorsal nucleus.obj","FJ7542_BP33158_FMA73003_Magnocellular part of left medial dorsal nucleus.obj","FJ7542M_BP33159_FMA73002_Magnocellular part of right medial dorsal nucleus.obj","FJ7543_BP35666_FMA73310_Left medial geniculate body.obj","FJ7543M_BP35526_FMA73309_Right medial geniculate body.obj","FJ7544_BP33950_FMA73032_Left inferior pulvinar nucleus.obj","FJ7544M_BP32549_FMA73031_Right inferior pulvinar nucleus.obj","FJ7545_BP36649_FMA73048_Left parafascicular nucleus.obj","FJ7545M_BP33152_FMA73047_Right parafascicular nucleus.obj","FJ7546_BP32531_FMA73022_Left oral pulvinar nucleus.obj","FJ7546M_BP33946_FMA73021_Right oral pulvinar nucleus.obj","FJ7547_BP33070_FMA72989_Left paratenial nucleus.obj","FJ7547M_BP33126_FMA72988_Right paratenial nucleus.obj","FJ7548_BP32531_FMA73022_Left oral pulvinar nucleus.obj","FJ7548M_BP33946_FMA73021_Right oral pulvinar nucleus.obj","FJ7550_BP34016_FMA73027_Left lateral pulvinar nucleus.obj","FJ7550M_BP34004_FMA73026_Right lateral pulvinar nucleus.obj","FJ7551_BP33727_FMA73030_Left medial pulvinar nucleus.obj","FJ7551M_BP33947_FMA73029_Right medial pulvinar nucleus.obj","FJ7553_BP32541_FMA73336_Left paraventricular nucleus of hypothalamus.obj","FJ7553M_BP34336_FMA73335_Right paraventricular nucleus of hypothalamus.obj","FJ7554_BP34019_FMA73324_Left thalamic reticular nucleus.obj","FJ7554M_BP33729_FMA73323_Right thalamic reticular nucleus.obj","FJ7556_BP36652_FMA73050_Left ventral anterior nucleus.obj","FJ7556M_BP34044_FMA73049_Right ventral anterior nucleus.obj","FJ7557_BP33155_FMA73064_Caudal part of left ventral lateral nucleus.obj","FJ7557M_BP33160_FMA73063_Caudal part of right ventral lateral nucleus.obj","FJ7558_BP33163_FMA73078_Oral part of left ventral posterolateral nucleus.obj","FJ7558M_BP33161_FMA73077_Oral part of right ventral posterolateral nucleus.obj","FJ7559_BP33162_FMA73080_Caudal part of left ventral posterolateral nucleus.obj","FJ7559M_BP33164_FMA73079_Caudal part of right ventral posterolateral nucleus.obj","FJ7560_BP33953_FMA73076_Left ventral posterolateral nucleus.obj","FJ7560M_BP34005_FMA73075_Right ventral posterolateral nucleus.obj","FJ7561_BP34043_FMA73085_Parvicellular part of left ventral posteromedial nucleus.obj","FJ7561M_BP33147_FMA73083_Parvicellular part of right ventral posteromedial nucleus.obj","FJ7562_BP32530_FMA73082_Left ventral posteromedial nucleus.obj","FJ7562M_BP33742_FMA73081_Right ventral posteromedial nucleus.obj","MM153_BP33379_FMA62488_Induseum griseum.obj","MM153M_BP33379_FMA62488_Induseum griseum.obj","MM155_BP33303_FMA77627_Medial olfactory stria.obj","MM155M_BP33303_FMA77627_Medial olfactory stria.obj","MM156_BP37113_FMA72956_Left diagonal band.obj","MM156M_BP34103_FMA72955_Right diagonal band.obj","MM164_BP35308_FMA72714_Left hippocampus proper.obj","MM164M_BP35175_FMA72713_Right hippocampus proper.obj","MM165_BP33357_FMA62485_Periamygdaloid area.obj","MM165M_BP33357_FMA62485_Periamygdaloid area.obj","MM167_BP33689_FMA235004_Fimbria of left hippocampus.obj","MM167M_BP34167_FMA235002_Fimbria of right hippocampus.obj","MM168_BP33207_FMA72933_Left posterior column of fornix.obj","MM168M_BP37213_FMA72932_Right posterior column of fornix.obj","MM169_BP34165_FMA72931_Body of left fornix of forebrain.obj","MM169M_BP33248_FMA72930_Body of right fornix of forebrain.obj","MM170_BP37111_FMA72927_Left anterior column of fornix.obj","MM170M_BP37112_FMA72926_Right anterior column of fornix.obj","MM171_BP35227_FMA72716_Dentate gyrus of left hippocampus.obj","MM171M_BP35118_FMA72715_Dentate gyrus of right hippocampus.obj","MM172_BP32591_FMA74884_Uncus.obj","MM172M_BP32591_FMA74884_Uncus.obj","MM173_BP32591_FMA74884_Uncus.obj","MM173M_BP32591_FMA74884_Uncus.obj","MM175_BP36188_FMA72712_Left fasciolar gyrus.obj","MM175M_BP33796_FMA72711_Right fasciolar gyrus.obj","MM176_BP33129_FMA72942_Left lateral longitudinal stria.obj","MM176M_BP33071_FMA72941_Right lateral longitudinal stria.obj","MM177_BP33150_FMA72944_Left medial longitudinal stria.obj","MM177M_BP33069_FMA72943_Right medial longitudinal stria.obj","MM178_BP32820_FMA74414_Subiculum.obj","MM178M_BP32820_FMA74414_Subiculum.obj","MM179_BP37128_FMA72833_Left amygdala.obj","MM179M_BP34038_FMA72832_Right amygdala.obj","MM193_BP36827_FMA72718_Left cingulate gyrus.obj","MM193M_BP34000_FMA72717_Right cingulate gyrus.obj","MM194_BP36188_FMA72712_Left fasciolar gyrus.obj","MM194M_BP33796_FMA72711_Right fasciolar gyrus.obj","MM202_BP36821_FMA72759_Left medial orbital gyrus.obj","MM202M_BP36471_FMA72758_Right medial orbital gyrus.obj","MM204_BP33701_FMA78462_Choroid plexus of third ventricle.obj","MM204M_BP33701_FMA78462_Choroid plexus of third ventricle.obj","MM205_BP33970_FMA78450_Left lateral ventricle.obj","MM205M_BP33961_FMA78449_Right lateral ventricle.obj","MM227_BP36821_FMA72759_Left medial orbital gyrus.obj","MM229_BP37110_FMA72936_Left lateral olfactory stria.obj","MM229M_BP34100_FMA72935_Right lateral olfactory stria.obj","MM230_BP36872_FMA80188_Left posterior orbital gyrus.obj","MM230M_BP36767_FMA80187_Right posterior orbital gyrus.obj","MM232_BP34430_FMA72721_Left first posterior central gyrus.obj","MM232M_BP36004_FMA72720_Right first posterior central gyrus.obj","MM233_BP33791_FMA72723_Left second posterior central gyrus.obj","MM233M_BP34404_FMA72722_Right second posterior central gyrus.obj","MM235_BP33792_FMA72728_Left second short gyrus of insula.obj","MM235M_BP34429_FMA72726_Right second short gyrus of insula.obj","MM236_BP33786_FMA72725_Left first short gyrus of insula.obj","MM236M_BP34384_FMA72724_Right first short gyrus of insula.obj","MM237_BP33785_FMA72730_Left intermediate short gyrus of insula.obj","MM237M_BP33784_FMA72729_Right intermediate short gyrus of insula.obj","MM239_BP36415_FMA72704_Left anterior accessory gyrus.obj","MM240_BP36415_FMA72704_Left anterior accessory gyrus.obj","MM241_BP33067_FMA72827_Left caudate nucleus.obj","MM241M_BP35798_FMA72826_Right caudate nucleus.obj","MM242_BP37051_FMA72670_Left angular gyrus.obj","MM242M_BP37180_FMA72669_Right angular gyrus.obj","MM243_BP36477_FMA72680_Left cuneus.obj","MM243M_BP36354_FMA72679_Right cuneus.obj","MM245_BP37172_FMA72676_Left superior occipital gyrus.obj","MM245M_BP36883_FMA72675_Right superior occipital gyrus.obj","MM246_BP36490_FMA72674_Left precuneus.obj","MM246M_BP36523_FMA72673_Right precuneus.obj","MM247_BP37028_FMA72672_Left superior parietal lobule.obj","MM247M_BP37000_FMA72671_Right superior parietal lobule.obj","MM248_BP36668_FMA72686_Left middle temporal gyrus.obj","MM248M_BP36762_FMA72685_Right middle temporal gyrus.obj","MM250_BP33811_FMA72668_Left supramarginal gyrus.obj","MM250M_BP36699_FMA72667_Right supramarginal gyrus.obj","MM251_BP36485_FMA72678_Left lateral occipital gyrus.obj","MM251M_BP36476_FMA72677_Right lateral occipital gyrus.obj","MM252_BP37117_FMA72682_Left lingual gyrus.obj","MM252M_BP36513_FMA72681_Right lingual gyrus.obj","MM253_BP36937_FMA72690_Left fusiform gyrus.obj","MM253M_BP36512_FMA72689_Right fusiform gyrus.obj","MM259_BP33994_FMA72692_Left anterior transverse temporal gyrus.obj","MM259M_BP36584_FMA72691_Right anterior transverse temporal gyrus.obj","MM261_BP33998_FMA72694_Left posterior transverse temporal gyrus.obj","MM261M_BP33996_FMA72693_Right posterior transverse temporal gyrus.obj","MM263_BP34403_FMA72739_Left posterior parahippocampal gyrus.obj","MM263M_BP33793_FMA72738_Right posterior parahippocampal gyrus.obj","MM264_BP34767_FMA72741_Left entorhinal area.obj","MM264M_BP33921_FMA72740_Right entorhinal area.obj","MM267_BP36480_FMA72684_Left superior temporal gyrus.obj","MM267M_BP36597_FMA72683_Right superior temporal gyrus.obj","MM268_BP36812_FMA72688_Left inferior temporal gyrus.obj","MM268M_BP36665_FMA72687_Right inferior temporal gyrus.obj","MM270_BP35995_FMA72737_Left presubiculum.obj","MM270M_BP34413_FMA72736_Right presubiculum.obj"];

        // GLOBAIS
        let scene, camera, renderer, controls, raycaster, mouse;
        let brainGroup; 
        let selectedKey = null;
        let hoveredKey = null;
        let objectsByKey = {}; 
        let activeExplode = 0;
        let isDarkTheme = true;
        let currentMode = "anat"; 

        const loaderManager = new THREE.LoadingManager();
        const basePositions = new Map();

        // UI Globals
        window.toggleAll = toggleAll;
        window.toggleLayer = toggleLayer;
        window.selectRegion = selectRegion;
        window.setHemisphere = setHemisphere;
        window.toggleTheme = toggleTheme;
        window.toggleMode = toggleMode;
        window.activateChem = activateChem;
        window.activatePath = activatePath;
        window.activateNet = activateNet;
        window.toggleMenuMobile = () => document.getElementById('menu').classList.toggle('open');
        window.closeInfo = () => document.getElementById('info').classList.remove('active');

        init();
        loadBrainParts();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x121214);
            scene.fog = new THREE.Fog(0x121214, 300, 1200);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 40, 160); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);
            const main = new THREE.DirectionalLight(0xffffff, 1.5);
            main.position.set(50, 80, 50);
            scene.add(main);
            const rim = new THREE.DirectionalLight(0x00f3ff, 1);
            rim.position.set(-100, 20, -50);
            scene.add(rim);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            brainGroup = new THREE.Group();
            scene.add(brainGroup);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onClick);
            window.addEventListener('resize', onWindowResize);

            document.getElementById('explode').addEventListener('input', (e) => {
                activeExplode = parseFloat(e.target.value);
            });

            loaderManager.onProgress = (url, loaded, total) => {
                const pct = (loaded / total) * 100;
                document.getElementById('progress').style.width = pct + '%';
            };

            loaderManager.onLoad = () => {
                const box = new THREE.Box3().setFromObject(brainGroup);
                const center = box.getCenter(new THREE.Vector3());
                brainGroup.position.x = -center.x;
                brainGroup.position.y = -center.y;
                brainGroup.position.z = -center.z;
                
                calculateExplosionVectors();
                generateMenu();

                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
                }, 500);
            };
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light-mode');
            const btn = document.getElementById('theme-toggle');
            if (isDarkTheme) {
                scene.background.setHex(0x121214);
                scene.fog.color.setHex(0x121214);
                btn.innerHTML = "‚òÄ";
            } else {
                scene.background.setHex(0xf0f2f5);
                scene.fog.color.setHex(0xf0f2f5);
                btn.innerHTML = "‚òæ";
            }
        }

        // --- SISTEMA DE MODOS ---
        function toggleMode(mode) {
            currentMode = mode;
            
            document.getElementById('net-toggle').classList.toggle('active-net', mode === 'net');
            document.getElementById('chem-toggle').classList.toggle('active-chem', mode === 'chem');
            document.getElementById('path-toggle').classList.toggle('active-path', mode === 'path');
            document.getElementById('anat-toggle').classList.toggle('active-anat', mode === 'anat');
            
            document.body.classList.remove('chem-mode', 'path-mode', 'net-mode');
            if(mode === 'chem') document.body.classList.add('chem-mode');
            if(mode === 'path') document.body.classList.add('path-mode');
            if(mode === 'net') document.body.classList.add('net-mode');

            selectedKey = null;
            document.getElementById('info').classList.remove('active');
            
            generateMenu();
            
            if (mode === 'anat') resetToAnatomy();
            else dimAll();
        }

        function dimAll() {
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    c.material.opacity = 0.1;
                    c.material.emissive.setHex(0x000000);
                    if(c.userData.outline) c.userData.outline.material.opacity = 0;
                }
            }));
        }

        function resetToAnatomy() {
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    c.material.opacity = 1;
                    c.material.color.setHex(c.userData.originalColor);
                    c.material.emissive.setHex(0x000000);
                    if(c.userData.outline) c.userData.outline.material.opacity = 0;
                }
            }));
        }

        function generateMenu() {
            const list = document.getElementById('menu-content');
            list.innerHTML = '';
            
            let dataMap, title;
            if (currentMode === 'anat') { dataMap = anatMap; title = 'Estruturas'; }
            else if (currentMode === 'chem') { dataMap = chemMap; title = 'Neurotransmissores'; }
            else if (currentMode === 'path') { dataMap = pathMap; title = 'Psicopatologias'; }
            else { dataMap = netMap; title = 'Redes Funcionais'; }

            document.getElementById('menu-title').innerText = title;
            document.getElementById('bulk-actions').style.display = currentMode === 'anat' ? 'flex' : 'none';

            const keys = Object.keys(dataMap).sort((a,b) => dataMap[a].name.localeCompare(dataMap[b].name));
            
            keys.forEach(key => {
                const item = dataMap[key];
                const row = document.createElement('div');
                row.className = 'menu-row';
                row.id = `row-${key}`;
                
                if (currentMode === 'anat') {
                    if (objectsByKey[key] && objectsByKey[key].length > 0) {
                        row.innerHTML = `
                            <div class="chk-wrapper" onclick="event.stopPropagation();">
                                <input type="checkbox" class="chk" checked onchange="toggleLayer('${key}', this.checked)">
                            </div>
                            <div class="dot" style="background:#${item.color.toString(16)}"></div>
                            <div class="menu-label" onclick="selectRegion('${key}')">${item.name}</div>
                        `;
                        list.appendChild(row);
                    }
                } else {
                    let fnName;
                    if(currentMode === 'chem') fnName = 'activateChem';
                    else if(currentMode === 'path') fnName = 'activatePath';
                    else fnName = 'activateNet';

                    row.innerHTML = `
                        <div class="dot" style="background:#${item.color.toString(16)}"></div>
                        <div class="menu-label" onclick="${fnName}('${key}')">${item.name}</div>
                    `;
                    list.appendChild(row);
                }
            });
        }

        // --- ATIVADORES ---
        function activateChem(key) {
            const data = chemMap[key];
            dimAll();
            highlightTargets(data.targets, data.color);
            updateInfoPanelCustom(data.name, data.func, data.color, data.desc, null);
            highlightMenuRow(key);
        }

        function activatePath(key) {
            const data = pathMap[key];
            dimAll();
            highlightTargets(data.targets, data.color);
            updateInfoPanelCustom(data.name, data.func, data.color, data.desc, null);
            highlightMenuRow(key);
        }

        function activateNet(key) {
            const data = netMap[key];
            dimAll();
            highlightTargets(data.targets, data.color);
            updateInfoPanelCustom(data.name, data.func, data.color, data.desc, null);
            highlightMenuRow(key);
        }

        function highlightTargets(targets, color) {
            Object.keys(targets).forEach(tKey => {
                if (objectsByKey[tKey]) {
                    objectsByKey[tKey].forEach(mesh => {
                        mesh.material.opacity = 1;
                        mesh.material.color.setHex(color);
                        mesh.material.emissive.setHex(0x222222);
                    });
                }
            });
        }

        function highlightMenuRow(key) {
            document.querySelectorAll('.menu-row').forEach(r => r.classList.remove('selected'));
            const row = document.getElementById(`row-${key}`);
            if(row) row.classList.add('selected');
        }

        function loadBrainParts() {
            const loader = new OBJLoader(loaderManager);
            Object.keys(anatMap).forEach(k => objectsByKey[k] = []);
            objectsByKey["other"] = [];

            fileList.forEach(filename => {
                loader.load('./' + filename, function (object) {
                    const nameLower = filename.toLowerCase();
                    let key = "other";
                    
                    // L√≥gica de Matching
                    for (const [k, kwords] of Object.entries(globalKeywords)) {
                        if (kwords.some(w => nameLower.includes(w))) {
                            key = k;
                            break;
                        }
                    }
                    if (key === "other") {
                         for (const [k, val] of Object.entries(anatMap)) {
                            if (val.keywords && val.keywords.some(w => nameLower.includes(w))) {
                                key = k;
                                break;
                            }
                        }
                    }

                    let side = 0; 
                    if (nameLower.includes("left")) side = -1;
                    else if (nameLower.includes("right")) side = 1;

                    object.traverse(function (child) {
                        if (child.isMesh) {
                            const data = key === "other" ? defaultRegion : anatMap[key];
                            
                            child.material = new THREE.MeshPhysicalMaterial({
                                color: data.color,
                                metalness: 0.1,
                                roughness: 0.3,
                                transmission: 0,
                                side: THREE.DoubleSide,
                                transparent: true
                            });
                            
                            child.userData = { 
                                originalColor: data.color,
                                key: key, 
                                side: side,
                                isVisibleByLayer: true, 
                                isVisibleByHemi: true   
                            };
                            
                            const edges = new THREE.EdgesGeometry(child.geometry);
                            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0 }));
                            child.add(line);
                            child.userData.outline = line;

                            objectsByKey[key].push(child);
                            basePositions.set(child, new THREE.Vector3(0,0,0));
                        }
                    });
                    brainGroup.add(object);
                });
            });
        }

        function calculateExplosionVectors() {
            Object.keys(objectsByKey).forEach(key => {
                if (key === 'other') return;
                const box = new THREE.Box3();
                let has = false;
                objectsByKey[key].forEach(mesh => {
                    if (!mesh.geometry.boundingBox) mesh.geometry.computeBoundingBox();
                    box.expandByObject(mesh);
                    has = true;
                });
                if (has) {
                    const center = new THREE.Vector3();
                    box.getCenter(center);
                    const dir = center.clone().normalize();
                    objectsByKey[key].forEach(mesh => mesh.userData.explodeDir = dir);
                }
            });
        }

        function toggleLayer(key, isChecked) {
            if(objectsByKey[key]) {
                objectsByKey[key].forEach(mesh => {
                    mesh.userData.isVisibleByLayer = isChecked;
                });
                updateMeshVisibility();
            }
        }

        function toggleAll(show) {
            if (currentMode !== 'anat') return;
            document.querySelectorAll('.chk').forEach(chk => chk.checked = show);
            Object.keys(objectsByKey).forEach(key => {
                objectsByKey[key].forEach(mesh => {
                    mesh.userData.isVisibleByLayer = show;
                });
            });
            updateMeshVisibility();
        }

        function updateMeshVisibility() {
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    const visible = c.userData.isVisibleByLayer && c.userData.isVisibleByHemi;
                    c.visible = visible;
                    const row = document.getElementById(`row-${c.userData.key}`);
                    if(row && currentMode === 'anat') {
                        if(!c.userData.isVisibleByLayer) row.classList.add('hidden-layer');
                        else row.classList.remove('hidden-layer');
                    }
                }
            }));
        }

        function setHemisphere(val) {
            document.querySelectorAll('.view-btn').forEach((b, i) => {
                const v = [-1, 0, 1][i];
                if(v === val) b.classList.add('active'); else b.classList.remove('active');
            });
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    const s = c.userData.side;
                    let visibleHemi = true;
                    if(val === -1 && s === 1) visibleHemi = false;
                    if(val === 1 && s === -1) visibleHemi = false;
                    c.userData.isVisibleByHemi = visibleHemi;
                }
            }));
            updateMeshVisibility();
        }

        function updatePhysics() {
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    const base = basePositions.get(c) || new THREE.Vector3();
                    const target = base.clone();
                    if(c.userData.explodeDir) {
                        target.add(c.userData.explodeDir.clone().multiplyScalar(activeExplode * 60));
                    }
                    if(selectedKey && c.userData.key === selectedKey && currentMode === 'anat') {
                        if(c.userData.explodeDir) target.add(c.userData.explodeDir.clone().multiplyScalar(20));
                        else target.z += 20;
                    }
                    c.position.lerp(target, 0.1);
                }
            }));
        }

        // --- INTERA√á√ÉO ---
        function getValidHit(x, y) {
            raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
            const intersects = raycaster.intersectObjects(brainGroup.children, true);
            return intersects.find(hit => hit.object.visible && hit.object.material.opacity > 0.2);
        }

        function onMouseMove(event) {
            if ('ontouchstart' in window) return; 

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            const hit = getValidHit(mouse.x, mouse.y);
            const tooltip = document.getElementById('tooltip');

            if (hit) {
                const key = hit.object.userData.key;
                if (hoveredKey !== key) {
                    hoveredKey = key;
                    if (!selectedKey) {
                        // Highlight somente se for anatomia OU contexto
                        let shouldHighlight = true;
                        if (currentMode !== 'anat') {
                            const activeContextKey = document.querySelector('.menu-row.selected')?.id?.replace('row-', '');
                            if (activeContextKey) {
                                const contextMap = currentMode === 'chem' ? chemMap : (currentMode === 'path' ? pathMap : netMap);
                                const contextData = contextMap[activeContextKey];
                                if (!contextData || !contextData.targets[key]) shouldHighlight = false;
                            } else {
                                shouldHighlight = false;
                            }
                        }

                        if (shouldHighlight) {
                            brainGroup.children.forEach(g => g.traverse(c => {
                                if(c.isMesh) c.material.emissive.setHex(c.userData.key === key ? 0x222222 : 0x000000);
                            }));
                        }
                    }
                    tooltip.innerText = key === 'other' ? "Estrutura" : anatMap[key].name;
                    tooltip.style.display = 'block';
                }
                tooltip.style.left = (event.clientX + 15) + 'px';
                tooltip.style.top = (event.clientY + 15) + 'px';
                document.body.style.cursor = 'pointer';
            } else {
                if (hoveredKey) {
                    if (!selectedKey) {
                        brainGroup.children.forEach(g => g.traverse(c => { if(c.isMesh) c.material.emissive.setHex(0x000000); }));
                    }
                    hoveredKey = null;
                }
                document.body.style.cursor = 'default';
                tooltip.style.display = 'none';
            }
        }

        function onClick(event) {
            if (event.target.closest('#menu') || event.target.closest('#info') || event.target.closest('#controls') || event.target.closest('.top-bar')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const hit = getValidHit(mouse.x, mouse.y);

            if (hit) {
                const key = hit.object.userData.key;
                
                // L√≥gica de Permiss√£o
                if (currentMode !== 'anat') {
                    const activeContextKey = document.querySelector('.menu-row.selected')?.id?.replace('row-', '');
                    if (!activeContextKey) return; 
                    const contextMap = currentMode === 'chem' ? chemMap : (currentMode === 'path' ? pathMap : netMap);
                    const contextData = contextMap[activeContextKey];
                    if (!contextData.targets[key]) return;
                }

                if (selectedKey === key) selectRegion(null);
                else selectRegion(key);
            } else {
                selectRegion(null);
            }
        }

        function selectRegion(key) {
            selectedKey = key;
            
            if (!key) {
                if (currentMode === 'anat') resetToAnatomy();
                else {
                    const activeContextKey = document.querySelector('.menu-row.selected')?.id?.replace('row-', '');
                    if (activeContextKey) {
                        const fnName = currentMode === 'chem' ? 'activateChem' : (currentMode === 'path' ? 'activatePath' : 'activateNet');
                        window[fnName](activeContextKey); 
                    }
                }
                document.getElementById('info').classList.remove('active');
                if (currentMode === 'anat') document.querySelectorAll('.menu-row').forEach(b => b.classList.remove('selected'));
                return;
            }

            // Ghost Mode
            brainGroup.children.forEach(g => g.traverse(c => {
                if(c.isMesh) {
                    c.material.opacity = 0.1; 
                    c.material.emissive.setHex(0x000000);
                    if(c.userData.outline) c.userData.outline.material.opacity = 0;
                }
            }));

            // Highlight
            if(objectsByKey[key]) {
                objectsByKey[key].forEach(mesh => {
                    mesh.material.opacity = 1; 
                    mesh.material.transparent = false;
                    mesh.material.emissive.setHex(0x333333);
                    if(mesh.userData.outline) mesh.userData.outline.material.opacity = 0.5;
                });
            }

            if (currentMode === 'anat') {
                document.querySelectorAll('.menu-row').forEach(b => b.classList.remove('selected'));
                const row = document.getElementById(`row-${key}`);
                if(row) {
                    row.classList.add('selected');
                    row.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }

            // INFO POPULATION
            const anatData = anatMap[key];
            let title = anatData.name;
            let func = anatData.func;
            let color = anatData.color;
            let desc = anatData.desc;
            let contextText = null;
            let contextTitle = "Contexto";

            if (currentMode !== 'anat') {
                const activeContextKey = document.querySelector('.menu-row.selected')?.id?.replace('row-', '');
                if (activeContextKey) {
                    const contextMap = currentMode === 'chem' ? chemMap : (currentMode === 'path' ? pathMap : netMap);
                    const contextData = contextMap[activeContextKey];
                    if (contextData && contextData.targets[key]) {
                        contextText = contextData.targets[key]; 
                        contextTitle = contextData.name; 
                        color = contextData.color; 
                    }
                }
            } else {
                if (anatData.clinical) {
                    contextText = anatData.clinical;
                    contextTitle = "Caso Cl√≠nico";
                }
            }

            updateInfoPanelCustom(title, func, color, desc, contextText, contextTitle);
        }

        function updateInfoPanelCustom(name, func, color, desc, contextText, contextTitle) {
            document.getElementById('info-name').innerText = name;
            document.getElementById('info-func').innerText = func;
            document.getElementById('info-func').style.color = '#' + color.toString(16);
            document.getElementById('info-desc').innerText = desc;
            
            const contextBox = document.getElementById('context-box');
            if(contextText) {
                contextBox.style.display = 'block';
                contextBox.style.borderLeftColor = '#' + color.toString(16);
                document.getElementById('context-title').innerText = contextTitle;
                document.getElementById('context-text').innerText = contextText;
            } else {
                contextBox.style.display = 'none';
            }
            
            document.getElementById('info').classList.add('active');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
